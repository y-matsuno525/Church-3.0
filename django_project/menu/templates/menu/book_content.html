{% load static %}
<div id="content-container" data-ajax-url="{% url 'menu:get_verses' %}" data-book-id="{{ book.id }}">
    <!-- 書名と章情報 -->
    <h2>{{ book.name }}</h2>
    <h3>第 {{ chapter.chapter_number }} 章</h3>

    <!-- ページ送りとセレクトボックス -->
    <div class="pagination">
        {% if chapter.previous_chapter %}
            <button class="pagination-button" data-chapter-number="{{ chapter.previous_chapter.chapter_number }}">前の章</button>
        {% endif %}

        <select class="chapter-selector">
            {% for ch in all_chapters %}
                <option value="{{ ch.chapter_number }}" {% if ch.chapter_number == chapter.chapter_number %}selected{% endif %}>
                    第 {{ ch.chapter_number }} 章
                </option>
            {% endfor %}
        </select>

        {% if chapter.next_chapter %}
            <button class="pagination-button" data-chapter-number="{{ chapter.next_chapter.chapter_number }}">次の章</button>
        {% endif %}
    </div>

    <!-- 節のリスト -->
    <ul class="verses">
        {% for verse in verses %}
            <li>
                <button class="forum-button" data-verse-id="{{ verse.id }}">注</button>
                <button id="openQuestions_{{verse.id}}">Q</button>
                <script>
                    document.getElementById("openQuestions_{{verse.id}}").addEventListener("click", function () {
                        window.open("{% url 'menu:get_verse_questions' %}?id={{verse.id}}", "_blank");
                    });
                </script>
                <strong>{{ verse.verse_number }}</strong>: {{ verse.text }}     
            </li>
        {% endfor %}
    </ul>

    <!-- ページ送り（再表示用） -->
    <div class="pagination">
        {% if chapter.previous_chapter %}
            <button class="pagination-button" data-chapter-number="{{ chapter.previous_chapter.chapter_number }}">前の章</button>
        {% endif %}

        <select class="chapter-selector">
            {% for ch in all_chapters %}
                <option value="{{ ch.chapter_number }}" {% if ch.chapter_number == chapter.chapter_number %}selected{% endif %}>
                    第 {{ ch.chapter_number }} 章
                </option>
            {% endfor %}
        </select>

        {% if chapter.next_chapter %}
            <button class="pagination-button" data-chapter-number="{{ chapter.next_chapter.chapter_number }}">次の章</button>
        {% endif %}
    </div>
</div>




<!--掲示板ポップアップ表示-->
<div id="forum-popup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid black; padding: 20px; z-index: 1000;">
    <button class="close" style="position: absolute; top: 10px; right: 10px;">閉じる</button>
    <div class="content">
        <!-- 掲示板の内容がここに挿入される -->
    </div>
</div>



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'verse_pagination.js' %}"></script>
<script>
    $(document).ready(function () {
        $(".forum-button").on("click", function (e) {
            e.preventDefault(); // デフォルトの動作を無効化

            var verseId = $(this).data("verse-id"); // Verse IDを取得

            // Ajaxリクエストを送信して注釈を取得
            $.ajax({
                url: "{% url 'menu:get_verse_annotations' %}", // 注釈一覧のURL
                method: "GET",
                data: {
                    verse_id: verseId
                },
                success: function (response) {
                    if (response.html) {
                    
                        // サブウィンドウを作成
                        var windowName = "AnnotationsWindow_" + verseId;
                        var newWindow = window.open("", windowName, "width=600,height=400,scrollbars=yes,resizable=yes");

                        // サブウィンドウにHTMLを挿入
                        newWindow.document.open();
                        newWindow.document.write(response.html); // response.html は完全なHTML構造じゃないとだめ
                        newWindow.document.close();
                    } else {
                        alert("掲示板の内容を取得できませんでした。");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("エラーが発生しました:", error);
                    console.error("レスポンス:", xhr.responseText);
                    alert("掲示板の内容を取得できませんでした。");
                }
            });
        });

        // ポップアップを閉じるボタン
        $("#forum-popup .close").on("click", function () {
            $("#forum-popup").hide(); // ポップアップを閉じる（非表示？）
        });
    });
</script>